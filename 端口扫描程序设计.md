# 端口扫描程序设计

## 实验要求

本实验掌握TCP全连接端口扫描的基本工作原理和Window socket工具，并使用Windows下的socket编程实现TCP全扫描主机端口扫描工具。

## 实验原理

### 端口扫描器

扫描器是一种自动检测远程或本地主机安全性弱点的程序。其既是用户保护自身网络安全的工具，也是黑客攻击的信息手机阶段的重要武器：

* 扫描器是一种网络安全性评估软件，利用扫描器可以快速、深入地对目标网络进行安全评估
* 扫描可以找出计算机网络系统中的安全隐患，进而被黑客利用。

端口是网络通信进程与外界通讯交流的出口，可被命名和寻址，可以认为是网络通信进程的一种标识符。端口扫描至进程通过系统调用与某端口建立连接绑定后，监听某端口，和它进行数据包的交换或建立连接，从而获取目标主机上运行着什么服务。

### TCP全连接扫描

TCP全连接是TCP端口扫描的基础。扫描主机使用三次握手尝试与目标主机的某个端口建立正规的连接。

#### 三次握手

三次握手是TCP全连接的重要方式，在此对其原理进行分析：

<img src="E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\端口扫描程序设计.assets\image-20210521113222845.png" alt="image-20210521113222845" style="zoom:33%;" />

主要流程描述为：

1. Client端发送SYN；
2. 如果端口开放：Server端返回SYN/ACK，表明端口开放；如果端口关闭：Server端返回RST/ACK
3. 如果Client端收到SYN/ACK，返回ACK，表明连接已建立；如果收到RST/ACK，返回RST，表明连接建立失败。

#### TCP全连接扫描

TCP全连接扫描流程图如下：

<img src="E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\端口扫描程序设计.assets\image-20210521112030411.png" alt="image-20210521112030411" style="zoom: 33%;" align="center" />

主要流程描述为：

1. 首先，扫描器获取需要扫描的目标ip地址，并获取相关扫描参数

2. 对需要扫描的端口按顺序进行扫描

3. 使用`socket()`建立新套接字
4. 使用三次握手尝试和端口建立TCP连接
5. 如果连接成功，则输出端口号并断开连接，跳转到步骤7
6. 如果连接失败，跳转到步骤7
7. 判断是否还有没有扫描的端口
8. 如果有，则跳转到步骤2
9. 如果没有，则断开连接，扫描结束

## 代码实现

### 输入参数

本端口扫描器可以通过命令行指定参数`args`的方式指定如下参数：

| 参数名 | 含义             | 类型 | 默认值  | 注释                         |
| ------ | ---------------- | ---- | ------- | ---------------------------- |
| ip     | 目标ip地址       | str  | None    | 必填                         |
| num    | 要扫描的端口数   | int  | 100     | 按照使用频率排序             |
| to     | timeout          | str  | 10      | 超时熔断                     |
| tn     | 并发线程数量上限 | int  | 100     |                              |
| p      | 目标端口         | int  | None    | 针对需要对特定端口扫描的情况 |
| m      | 消息             | str  | "hello" |                              |

更多详细设置如下：

<img src="E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\端口扫描程序设计.assets\image-20210521181004651.png" alt="image-20210521181004651" style="zoom:50%;" />

### 扫描器类

通过实现`Scanner`类来实现扫描器的核心功能。

#### 构造器

扫描器的构造器主要行为有以下：

* 解析端口文件

  为了对所有端口的运行协议、使用频率等进行归纳，本项目通过读取`nmap-services.dat`文件并进行解析来获得所有端口的基本信息，从而根据输入参数来选取参与扫描的端口。`nmap-services.dat`的局部概览如下：

  <img src="E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\端口扫描程序设计.assets\image-20210521181407380.png" alt="image-20210521181407380" style="zoom:50%;" />

  在本端口扫描器的解析中，主要是对数据的第二、三列进行解析，即端口号、协议、使用频率。具体解析函数实现位于`PortUtils/parse_port.py`。

* 设置基本参数

  通过读入控制台的参数，扫描器在构造方法中对待扫描IP、扫描端口数、指定端口等参数进行了设定。

### 端口扫描

在正式的端口扫描中，端口扫描器主要按照以下流程进行工作。

#### 准备阶段

在准备阶段，主要对需要扫描的域名或者ip地址进行格式审查和存在性审查。

首先，调用`socket.inet_aton(ip)`方法将输入ip地址转换为一个32位的网络序列IP地址，并对异常情况进行特殊处理。

其次，调用`socket.gethostbyname(ip)`方法对输入的域名获取ip地址，并对异常情况进行特殊处理。

准备阶段的具体代码实现见`/Scanner/PortScanner.py`。

#### 开始扫描

开始扫描后，首先初始化所有端口的状态为`CLOSED`，然后根据端口列表进行顺序扫描。

首先，使用`concurrent.futures.ThreadPoolExecutor(max_workers=self.thread_num_bound)`开启多线程执行器，提高端口扫描器的扫描效率。

然后，遍历所有的端口，执行`executor.submit(self.try_TCP_connection, ip, port, message)`提交对端口的扫描请求，并将执行器加入队列。如果当前队列数目大于等于规定的最大线程数，则获取结果。

其中，`try_TCP_connection`为端口尝试连接的核心函数，其逻辑如下：

1. 新建TCP_socket和UDP_socket
2. 使用`sendto`方法尝试发送报文，并获取返回值
3. 如果返回值是0，说明端口打开，否则关闭

对于结果的获取，遍历当前队列中的每一个线程，查看是否已经执行完毕。如果执行完毕，获取执行结果。如果获取端口结果为`OPEN`，则更新该端口的状态，并输出提示信息。

扫描阶段的具体代码实现见`/Scanner/PortScanner.py`。

#### 记录执行时间

在扫描结束后，获取当前系统时间，和开始扫描前系统时间做差，求出本次扫描花费的总时长。

## 实验结果

### 对本机进行扫描

#### 开启防火墙

在开启本机防火墙的情况下，我在远程服务器上运行该端口扫描器，对本机ip地址进行扫描。得到的结果如下：

![image-20210523134828915](E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\端口扫描程序设计.assets\image-20210523134828915.png)

可以看到，无法获取到任何一个端口的信息。

#### 关闭防火墙

通过关闭windows自带域网络、专用网络和公用网络防火墙，重新进行扫描。或者，直接在本机运行端口扫描程序对本机端口开放情况进行扫描。本机ip地址通过在cmd使用ipconfig命令即可查看，并设置扫描使用频率前1000的端口进行扫描。结果如下：

<img src="E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\端口扫描程序设计.assets\image-20210523134722415.png" alt="image-20210523134722415" style="zoom: 50%;" />

可以看到，在没有防火墙的保护下，可以对本主机的端口开放情况进行扫描。

### 对公网ip进行扫描

为了进一步验证本端口扫描器的有效性，实验中还选取了多个公网ip进行扫描。扫描结果如下：

![](E:\YH\大三下\网络攻防\实验报告\端口扫描程序设计\console2.png)

本ip地址上正在运行某web应用，因此80端口出于打开状态。